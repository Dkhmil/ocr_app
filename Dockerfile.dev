# Single-stage Dockerfile for faster local development
# This skips the Maven build and expects you to build the JAR locally first
# Usage: mvn clean package && docker build -f Dockerfile.dev -t ocr-app:dev .

FROM eclipse-temurin:21-jre-jammy

# Install OCRmyPDF and OCR runtime dependencies
RUN apt-get update && \
    apt-get install -y \
    ocrmypdf \
    tesseract-ocr-eng \
    tesseract-ocr-ukr \
    curl \
    && rm -rf /var/lib/apt/lists/*

# Normalize tessdata path across distro package versions (e.g. 4.00 vs 5).
RUN set -eux; \
    TESSDATA_DIR="$(find /usr/share -type d -path '*/tessdata' | head -n 1)"; \
    test -n "$TESSDATA_DIR"; \
    ln -s "$TESSDATA_DIR" /usr/share/tessdata

WORKDIR /app

# Copy the pre-built JAR
COPY target/*.jar app.jar

# Create directory for temporary PDF processing
RUN mkdir -p /tmp/ocr && chmod 777 /tmp/ocr

EXPOSE 8080

ENV TESSDATA_PREFIX=/usr/share/tessdata/
ENV JAVA_OPTS="-Xmx512m -Xms256m"

ENTRYPOINT ["sh", "-c", "java $JAVA_OPTS -jar app.jar"]
